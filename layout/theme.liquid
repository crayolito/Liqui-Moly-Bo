{%- assign text_direction = 'localization.text_direction' | t | downcase -%}
<!doctype html>
<html
  lang="{{ request.locale.iso_code }}"
  {% if text_direction == 'rtl' %}
    dir="{{ text_direction }}"
  {% endif %}
>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>
      {{ page_title }}
      {%- if current_tags %}
        &ndash; {% assign page_tags = current_tags | join: ', ' -%}
        {{- 'accessibility.page_title.tagged_as' | t: tags: page_tags -}}
      {%- endif -%}
      {%- if current_page != 1 %}
        &ndash; {{ 'accessibility.page_title.page_number' | t: page_number: current_page -}}
      {%- endif -%}
      {%- unless page_title contains shop.name %} &ndash; {{ shop.name }}{% endunless -%}
    </title>

    {% # theme-check-disable RemoteAsset %}
    <link rel="preconnect" href="//cdn.shopify.com" crossorigin>
    {% # theme-check-enable RemoteAsset %}

    {% unless settings.typography_headings.system? and settings.typography_body.system? %}
      {% # theme-check-disable RemoteAsset %}
      <link rel="preconnect" href="//fonts.shopifycdn.com" crossorigin>
      {% # theme-check-enable RemoteAsset %}
    {% endunless %}

    {% comment %}theme-check-disable AssetPreload{% endcomment %}
    {% unless settings.typography_body.system? %}
      <link
        rel="preload"
        as="font"
        href="{{ settings.typography_body | font_url }}"
        type="font/woff2"
        crossorigin
      >
    {% endunless %}
    {% unless settings.typography_headings.system? %}
      <link
        rel="preload"
        as="font"
        href="{{ settings.typography_headings | font_url }}"
        type="font/woff2"
        crossorigin
      >
    {% endunless %}
    {% comment %}theme-check-enable AssetPreload{% endcomment %}
    {% render 'head-css' %}

    <style>
      html {
        box-sizing: border-box;
        -ms-overflow-style: scrollbar;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        height: 100%;
        font-size: calc(var(--font-body-scale) * 62.5%);
        scroll-behavior: smooth;
        line-height: 1.15;
        -webkit-text-size-adjust: 100%;
      }

      * {
        box-sizing: inherit;
      }

      *::before,
      *::after {
        box-sizing: inherit;
      }

      body {
        min-height: 100%;
        font-size: 1.5rem;
        line-height: calc(1 + 0.6 / var(--font-body-scale));
        font-family: var(--font-body-family);
        font-style: var(--font-body-style);
        font-weight: var(--font-body-weight);
        text-transform: none;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        word-wrap: break-word;
        overflow-wrap: break-word;
        margin: 0;
      }

      .drawer {
        position: fixed;
        top: 0;
        inset-inline-end: 0;
        height: 100dvh;
        width: 85vw;
        max-width: 40rem;
        transform: translateX(calc(100% + 5rem));
      }

      [dir='rtl'] .drawer {
        transform: translateX(calc(-100% - 5rem));
      }

      .dropdown-list-wrap {
        visibility: hidden;
        opacity: 0;
      }

      .breadcrumb {
        display: none;
      }

      @media (min-width: 990px) {
        .breadcrumb {
          display: block;
        }
      }

      slideshow-component {
        display: block;
        height: auto;
        overflow: visible;
      }

      .slideshow {
        position: relative;
        display: block;
        overflow: hidden;
      }

      .slideshow-slide {
        position: relative;
        width: 100%;
        display: block;
        flex: none;
      }
    </style>

    {{ 'base.css' | asset_url | stylesheet_tag }}

    <script src="{{ 'pubsub.js' | asset_url }}" defer="defer"></script>
    <script src="{{ 'scripts.js' | asset_url }}" defer="defer"></script>

    {{ content_for_header }}

    <script>
      if (Shopify.designMode) {
        document.documentElement.classList.add('shopify-design-mode');
      }
    </script>

    {%- if request.design_mode -%}
      {{ 'section-slideshow.css' | asset_url | stylesheet_tag }}
      {{ 'flickity.css' | asset_url | stylesheet_tag }}
      {{ 'component-scroller.css' | asset_url | stylesheet_tag }}
      {{ 'theme-editor.css' | asset_url | stylesheet_tag }}
      <script src="{{ 'flickity.pkgd.js' | asset_url }}" defer="defer"></script>
      <script src="{{ 'carousel-slider.js' | asset_url }}" defer="defer"></script>
      <script src="{{ 'slideshow.js' | asset_url }}" defer="defer"></script>
      <script src="{{ 'map.js' | asset_url }}" defer="defer"></script>
      <script src="{{ 'recipient-form.js' | asset_url }}" defer="defer"></script>
      <script src="{{ 'countdown.js' | asset_url }}" defer="defer"></script>
      <script src="{{ 'video-background.js' | asset_url }}" defer="defer"></script>
      <script src="{{ 'image-hotspots.js' | asset_url }}" defer="defer"></script>
      <script src="{{ 'text-slider.js' | asset_url }}" defer="defer"></script>
      <script src="{{ 'product-modal.js' | asset_url }}" defer="defer"></script>
      <script src="{{ 'media-gallery.js' | asset_url }}" defer="defer"></script>
      <script src="{{ 'product-request-information.js' | asset_url }}" defer="defer"></script>
      <script src="{{ 'popup-overlay.js' | asset_url }}" defer="defer"></script>
      <script src="{{ 'section-age-verification.js' | asset_url }}" defer="defer"></script>
      <script src="{{ 'scrolling-elements.js' | asset_url }}" defer="defer"></script>
      <script src="{{ 'before-after-slider.js' | asset_url }}" defer="defer"></script>
      <script src="{{ 'theme-editor.js' | asset_url }}" defer="defer"></script>
    {%- endif -%}

    {% if page_description %}
      <meta name="description" content="{{ page_description | escape }}">
    {% endif %}
    <link rel="canonical" href="{{ canonical_url }}">
    {% render 'meta-tags' %}
    {% if settings.favicon != blank %}
      <link
        rel="icon"
        type="image/png"
        href="{{ settings.favicon | image_url: width: 32, height: 32 }}"
      >
    {% endif %}
  </head>

  {% liquid
    assign body_class = 'template-' | append: template.name
    assign body_class = body_class | append: ' setting-buttons-' | append: settings.buttons_style
    assign body_class = body_class | append: ' setting-buttons-size-' | append: settings.buttons_size
    assign body_class = body_class | append: ' settings-remove-ribbons-' | append: settings.remove_card_ribbon
    assign body_class = body_class | append: ' setting-color-swatch-shape-' | append: settings.color_swatches_shape

    if settings.product_cards_border_enabled == false
      assign body_class = body_class | append: ' setting-card-product-unboxed'
    endif
  %}

  <script>
    /**
     * M√ìDULO DE CHECKOUT PERSONALIZADO
     * Funciones compartidas y optimizadas para todos los flujos de checkout
     * Cargado globalmente en theme.liquid
     */
    (function() {
      'use strict';
  
      // Evitar redeclarar si ya existe
      if (window.CustomCheckout) {
        return;
      }
  
      // ========== CONFIGURACI√ìN ==========
      const CONFIG = {
        CHECKOUT_SUCCESS_URL: '/pages/checkout-success',
        ENABLE_DEBUG: false, // Cambiar a true para debug
        CART_CLEAR_ENABLED: true,
        USE_CUSTOM_CHECKOUT: true, // Para Buy Now buttons
      };
  
      // ========== UTILIDADES ==========
      const debug = {
        log: (...args) => CONFIG.ENABLE_DEBUG && console.log(...args),
        error: (...args) => CONFIG.ENABLE_DEBUG && console.error(...args),
        warn: (...args) => CONFIG.ENABLE_DEBUG && console.warn(...args),
      };
  
      // ========== FUNCIONES DE DATOS DEL CLIENTE ==========
      function obtenerDatosCliente() {
        {% if customer %}
        return {
          nombre: "{{ customer.first_name | escape }} {{ customer.last_name | escape }}".trim(),
          email: "{{ customer.email | escape }}",
          telefono: "{{ customer.phone | default: '' | escape }}",
          direccion: "{% if customer.default_address %}{{ customer.default_address.address1 | escape }}{% if customer.default_address.address2 %}, {{ customer.default_address.address2 | escape }}{% endif %}, {{ customer.default_address.city | escape }}{% endif %}",
          id: {{ customer.id }},
          logueado: true
        };
        {% else %}
        return {
          logueado: false,
          nombre: 'Invitado',
          email: '',
          telefono: '',
          direccion: ''
        };
        {% endif %}
      }
  
      function guardarDatosCliente() {
        const customerData = obtenerDatosCliente();
        localStorage.setItem('customerData', JSON.stringify(customerData));
        debug.log('üë§ Datos del cliente guardados:', customerData.nombre || 'Invitado');
        return customerData;
      }
  
      // ========== CONSTRUCCI√ìN DE DATOS DE PEDIDO ==========
      function construirItemPedido(item) {
        const baseItem = {
          variant_id: item.variant_id || item.id,
          product_id: item.product_id || item.product?.id,
          title: item.title || item.product?.title || '',
          variant_title: item.variant_title || item.title || 'Default Title',
          quantity: item.quantity || 1,
          price: item.price || 0,
          price_cents: item.price_cents || Math.round((item.price || 0) * 100),
          compare_at_price: item.compare_at_price || 0,
          sku: item.sku || '',
          image: item.image || '',
          url: item.url || item.product?.url || '',
          vendor: item.vendor || item.product?.vendor || '',
          product_type: item.product_type || item.product?.type || '',
          price_formatted: item.price_formatted || ''
        };
  
        // Agregar opciones si existen
        if (item.option1) baseItem.option1 = item.option1;
        if (item.option2) baseItem.option2 = item.option2;
        if (item.option3) baseItem.option3 = item.option3;
        if (item.options) baseItem.options = item.options;
  
        return baseItem;
      }
  
      function construirDatosPedido(items, total = null) {
        const orderData = {
          orderNumber: 'LM' + Date.now(),
          items: Array.isArray(items) ? items.map(construirItemPedido) : [construirItemPedido(items)],
          timestamp: new Date().toISOString()
        };
  
        // Calcular totales si no se proporcionan
        if (total === null) {
          orderData.total = orderData.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
          orderData.total_cents = orderData.items.reduce((sum, item) => sum + (item.price_cents * item.quantity), 0);
        } else {
          orderData.total = typeof total === 'number' ? total : (total / 100);
          orderData.total_cents = typeof total === 'number' ? (total * 100) : total;
        }
  
        orderData.subtotal = orderData.total;
        
        // Formatear precio
        try {
          orderData.total_formatted = new Intl.NumberFormat('es-BO', {
            style: 'currency',
            currency: 'BOB'
          }).format(orderData.total);
        } catch (e) {
          orderData.total_formatted = 'Bs. ' + orderData.total.toFixed(2);
        }
  
        return orderData;
      }
  
      // ========== FUNCI√ìN DE CHECKOUT (CORE) ==========
      async function procesarCheckoutPersonalizado(orderData, options = {}) {
        const {
          limpiarCarrito = CONFIG.CART_CLEAR_ENABLED,
          cerrarDrawer = false,
          onSuccess = null,
          onError = null
        } = options;
  
        try {
          // Guardar datos del cliente
          guardarDatosCliente();
  
          // Guardar datos del pedido
          localStorage.setItem('customOrderData', JSON.stringify(orderData));
          debug.log('üíæ Datos guardados en localStorage:', orderData);
  
          // Limpiar carrito si es necesario
          if (limpiarCarrito) {
            await limpiarCarritoShopify();
          }
  
          // Cerrar drawer si es necesario
          if (cerrarDrawer) {
            cerrarMiniCartDrawer();
          }
  
          // Callback de √©xito
          if (onSuccess && typeof onSuccess === 'function') {
            onSuccess(orderData);
          }
  
          // Redirigir
          window.location.href = CONFIG.CHECKOUT_SUCCESS_URL;
  
        } catch (error) {
          debug.error('üí• Error en checkout personalizado:', error);
          
          if (onError && typeof onError === 'function') {
            onError(error);
          } else {
            // Fallback: redirigir de todas formas si ya se guardaron los datos
            if (localStorage.getItem('customOrderData')) {
              window.location.href = CONFIG.CHECKOUT_SUCCESS_URL;
            }
          }
        }
      }
  
      // ========== FUNCIONES AUXILIARES ==========
      async function limpiarCarritoShopify() {
        try {
          const response = await fetch('/cart/clear.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          debug.log('‚úÖ Carrito limpiado');
          return true;
        } catch (error) {
          debug.error('‚ùå Error al limpiar carrito:', error);
          throw error;
        }
      }
  
      function cerrarMiniCartDrawer() {
        const drawerToggle = document.querySelector('drawer-toggle[for="HeaderMiniCart"]');
        if (drawerToggle) {
          drawerToggle.click();
          debug.log('‚úÖ Drawer cerrado');
        }
      }
  
      // ========== EXPORTAR FUNCIONES P√öBLICAS ==========
      window.CustomCheckout = {
        // Funci√≥n principal
        procesar: procesarCheckoutPersonalizado,
        
        // Funciones auxiliares
        obtenerDatosCliente,
        guardarDatosCliente,
        construirDatosPedido,
        construirItemPedido,
        limpiarCarrito: limpiarCarritoShopify,
        cerrarDrawer: cerrarMiniCartDrawer,
        
        // Configuraci√≥n
        config: CONFIG,
        debug
      };
  
      debug.log('‚úÖ M√≥dulo CustomCheckout cargado globalmente');
    })();
  </script>

  <body class="{{ body_class }}">
    <a class="skip-link visually-hidden visually-hidden-focusable" href="#MainContent">
      {{- 'accessibility.link_messages.skip_to_text' | t -}}
    </a>

    {% sections 'header-group' %}

    <main id="MainContent" class="main" role="main" tabindex="-1">
      {% if settings.breadcrumbs_enabled %}
        {% render 'breadcrumb' %}
      {% endif %}

      {{ content_for_layout }}
    </main>

    <footer class="footer">
      {% sections 'footer-group' %}
      {% render 'header-mini-cart' %}
    </footer>

    {% sections 'overlays-group' %}

    {% liquid
      if settings.products_quickadd_no_variants == 'quickview' or settings.products_quickadd_variants == 'quickview'
        render 'quick-view-drawer'
      endif
    %}

    {%- if settings.predictive_search_enabled -%}
      <script src="{{ 'predictive-search.js' | asset_url }}" defer="defer"></script>
    {%- endif -%}
  </body>
</html>
