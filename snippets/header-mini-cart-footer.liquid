{% comment %}
  Renders the mini cart's footer

  Usage:
  {% render 'header-mini-cart-footer' %}
{% endcomment %}

{%- if cart != empty -%}
  <div class="mini-cart-footer">
    {% if settings.minicart_show_coupon_code %}
      {% render 'cart-coupon', minicart: true %}
    {% endif %}

    {%- if cart.cart_level_discount_applications.size > 0 -%}
      <ul
        class="discounts list-unstyled"
        role="list"
        aria-label="{{ 'customer.order.discount' | t }}"
      >
        {%- for discount in cart.cart_level_discount_applications -%}
          <li class="discounts-discount discounts-discount-position">
            {% render 'icons', icon: 'label' %}
            {{ discount.title }}
            (-{{ discount.total_allocated_amount | money }})
          </li>
        {%- endfor -%}
      </ul>
    {%- endif -%}

    <div id="mini-cart-totals" class="mini-cart-recap">
      <span>{{ 'templates.cart.headings.total' | t }}</span>
      <span>{{ cart.total_price | money_with_currency }}</span>
    </div>

    {% if settings.cart_policy_consent_page != blank %}
      <div class="mini-cart-terms-conditions-disclaimer">
        <cart-consent-checkbox>
          <label class="checkbox-cart-policy-consent" for="checkbox-cart-policy-consent-mini-cart">
            <input type="checkbox" id="checkbox-cart-policy-consent-mini-cart" required>
            <span class="rte">
              {{
                'templates.cart.checkbox_cart_policy_consent_html'
                | t: link: settings.cart_policy_consent_page.url, label: settings.cart_policy_consent_page.title
              }}
            </span>
          </label>
        </cart-consent-checkbox>
      </div>
    {% endif %}

    <div class="mini-cart-footer-actions">
      <a href="{{ routes.cart_url }}" class="button button-tertiary">
        {{ 'sections.minicart.view_cart' | t }}
        {% render 'angle', direction: 'right' %}
      </a>

      {% comment %}
        Botón original que lleva al checkout nativo - COMENTADO
        <button type="submit" class="button" name="checkout">
          {{ 'templates.cart.checkout' | t }}
          {% render 'angle', direction: 'right' %}
        </button>
      {% endcomment %}

      <button type="button" class="button" id="mini-cart-custom-checkout">
        Finalizar compra
        {% render 'angle', direction: 'right' %}
      </button>
    </div>

    <span class="spinner-sm"></span>
  </div>
{%- endif -%}

<script>
  (function() {
    'use strict';

    const CONFIG = {
      BUTTON_ID: 'mini-cart-custom-checkout',
      BIND_DELAYS: [0, 500, 1000],
      DRAWER_SELECTOR: 'drawer-toggle[for="HeaderMiniCart"]'
    };

    function handleMiniCartCheckout() {
      // Verificar que el módulo CustomCheckout esté disponible
      if (!window.CustomCheckout) {
        console.error('❌ Módulo CustomCheckout no disponible');
        alert('Error: Sistema de checkout no disponible. Por favor, recarga la página.');
        return;
      }

      if ({{ cart.item_count }} === 0) {
        if (window.CustomCheckout.debug) {
          window.CustomCheckout.debug.warn('⚠️ Carrito vacío');
        } else {
          console.warn('⚠️ Carrito vacío');
        }
        return;
      }

      // Construir datos del pedido (misma estructura que carrito principal)
      const orderData = window.CustomCheckout.construirDatosPedido([
        {% for item in cart.items %}
        {
          variant_id: {{ item.variant.id }},
          product_id: {{ item.product.id }},
          title: "{{ item.product.title | escape }}",
          variant_title: "{{ item.variant.title | escape }}",
          quantity: {{ item.quantity }},
          price: {{ item.variant.price | divided_by: 100.0 }},
          price_cents: {{ item.variant.price }},
          compare_at_price: {{ item.variant.compare_at_price | default: 0 | divided_by: 100.0 }},
          sku: "{{ item.variant.sku | escape }}",
          image: "{% if item.variant.image %}{{ item.variant.image | image_url: width: 300 }}{% elsif item.product.featured_image %}{{ item.product.featured_image | image_url: width: 300 }}{% endif %}",
          url: "{{ item.product.url }}",
          vendor: "{{ item.product.vendor | escape }}",
          product_type: "{{ item.product.type | escape }}",
          {% if item.variant.option1 %}option1: "{{ item.variant.option1 | escape }}",{% endif %}
          {% if item.variant.option2 %}option2: "{{ item.variant.option2 | escape }}",{% endif %}
          {% if item.variant.option3 %}option3: "{{ item.variant.option3 | escape }}",{% endif %}
          price_formatted: "{{ item.final_price | money }}"
        }{% unless forloop.last %},{% endunless %}
        {% endfor %}
      ], {{ cart.total_price }});

      // Procesar checkout con cierre de drawer
      window.CustomCheckout.procesar(orderData, {
        limpiarCarrito: true,
        cerrarDrawer: true
      });
    }

    function bindButton(button) {
      if (!button || button.hasAttribute('data-bound')) return false;

      // Verificar que CustomCheckout esté disponible antes de usar debug
      if (!window.CustomCheckout) {
        console.error('❌ CustomCheckout no disponible para bindButton');
        return false;
      }

      button.setAttribute('data-bound', 'true');
      button.addEventListener('click', function(e) {
        e.preventDefault();
        handleMiniCartCheckout();
      });

      // Usar debug de forma segura
      if (window.CustomCheckout.debug) {
        window.CustomCheckout.debug.log('✅ Botón mini-cart vinculado');
      } else {
        console.log('✅ Botón mini-cart vinculado');
      }
      return true;
    }

    function initMiniCartCheckout() {
      const button = document.getElementById(CONFIG.BUTTON_ID);
      return bindButton(button);
    }

    // Inicialización
    document.addEventListener('DOMContentLoaded', function() {
      // Intentos iniciales con delays
      CONFIG.BIND_DELAYS.forEach(delay => {
        if (delay === 0) {
          initMiniCartCheckout();
        } else {
          setTimeout(initMiniCartCheckout, delay);
        }
      });

      // Observer para cambios en el DOM
      const observer = new MutationObserver(function(mutations) {
        for (const mutation of mutations) {
          if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
            if (initMiniCartCheckout()) break; // Si se vinculó, salir
          }
        }
      });

      observer.observe(document.body, {
        childList: true,
        subtree: true
      });

      // Vincular cuando se abre el drawer
      document.addEventListener('click', function(e) {
        if (e.target.closest(CONFIG.DRAWER_SELECTOR)) {
          setTimeout(initMiniCartCheckout, 100);
        }
      }, { passive: true });
    });
  })();
</script>
