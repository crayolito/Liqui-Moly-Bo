{{ 'section-checkout-success.css' | asset_url | stylesheet_tag }}

<div class="checkout-success-container">
  <div class="checkout-success-content">
    <!-- Imagen de check verde -->
    <div class="success-icon">
      <img
        src="{{ 'imagen-check-verde.png' | asset_url }}"
        alt="Pedido Confirmado"
        class="success-image"
        width="80"
        height="80"
      >
    </div>

    <h1 class="success-title">{{ section.settings.titulo_1 | default: '¬°PEDIDO CONFIRMADO!' }}</h1>

    <p class="success-message">
      {{
        section.settings.titulo_2
        | default: 'Gracias por escogernos. En breve nuestro equipo se contactar√° contigo v√≠a WhatsApp para coordinar la entrega de tu pedido.'
      }}
    </p>
    <div class="order-number">
      <span>N√∫mero de Orden: <span id="numero-orden">Procesando...</span></span>
    </div>

    <!-- Estado del pedido -->
    <div id="estado-pedido" class="estado-procesando">
      <div class="loading-text">
        <p>Procesando orden...</p>
      </div>
    </div>

    <!-- Secci√≥n WhatsApp -->
    <div class="whatsapp-redirect" id="seccion-whatsapp" style="display: none;">
      <div class="countdown-container">
        <p class="redirect-message">Te redirigiremos a WhatsApp en <span id="countdown">5</span> segundos...</p>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
      </div>

      <button id="whatsapp-ahora" class="button button-whatsapp">Ir a WhatsApp</button>
    </div>

    <!-- Configuraci√≥n del tel√©fono (solo si est√° habilitada) -->
    {% if section.settings.show_phone_config %}
      <div
        class="phone-config"
        style="margin-top: 2rem; padding: 1rem; background: rgba(var(--color-aux-background)); border-radius: var(--border-radius);"
      >
        <label for="phone-input" style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem;"
          >N√∫mero de WhatsApp:</label
        >
        <input
          type="text"
          id="phone-input"
          value="{{ section.settings.whatsapp_number }}"
          style="width: 100%; padding: 0.5rem; border: 1px solid rgba(var(--color-border)); border-radius: var(--border-radius);"
        >
        <small style="display: block; margin-top: 0.5rem; opacity: 0.7;">Incluir c√≥digo de pa√≠s sin +</small>
      </div>
    {% endif %}
  </div>
</div>

{% assign mensaje_default = 'Buenas, mi n√∫mero de orden es el siguiente: {NUMERO_ORDEN}, por favor me atiende' %}

<script>
  /**
   * M√ìDULO DE CHECKOUT PERSONALIZADO
   * Funciones compartidas y optimizadas para todos los flujos de checkout
   */
  (function() {
    'use strict';

    // ========== CONFIGURACI√ìN ==========
    const CONFIG = {
      CHECKOUT_SUCCESS_URL: '/pages/checkout-success',
      ENABLE_DEBUG: false, // Cambiar a true para debug
      CART_CLEAR_ENABLED: true,
      USE_CUSTOM_CHECKOUT: true, // Para Buy Now buttons
    };

    // ========== UTILIDADES ==========
    const debug = {
      log: (...args) => CONFIG.ENABLE_DEBUG && console.log(...args),
      error: (...args) => CONFIG.ENABLE_DEBUG && console.error(...args),
      warn: (...args) => CONFIG.ENABLE_DEBUG && console.warn(...args),
    };

    // ========== FUNCIONES DE DATOS DEL CLIENTE ==========
    function obtenerDatosCliente() {
      {% if customer %}
      return {
        nombre: "{{ customer.first_name | escape }} {{ customer.last_name | escape }}".trim(),
        email: "{{ customer.email | escape }}",
        telefono: "{{ customer.phone | default: '' | escape }}",
        direccion: "{% if customer.default_address %}{{ customer.default_address.address1 | escape }}{% if customer.default_address.address2 %}, {{ customer.default_address.address2 | escape }}{% endif %}, {{ customer.default_address.city | escape }}{% endif %}",
        id: {{ customer.id }},
        logueado: true
      };
      {% else %}
      return {
        logueado: false,
        nombre: 'Invitado',
        email: '',
        telefono: '',
        direccion: ''
      };
      {% endif %}
    }

    function guardarDatosCliente() {
      const customerData = obtenerDatosCliente();
      localStorage.setItem('customerData', JSON.stringify(customerData));
      debug.log('üë§ Datos del cliente guardados:', customerData.nombre || 'Invitado');
      return customerData;
    }

    // ========== CONSTRUCCI√ìN DE DATOS DE PEDIDO ==========
    function construirItemPedido(item) {
      const baseItem = {
        variant_id: item.variant_id || item.id,
        product_id: item.product_id || item.product?.id,
        title: item.title || item.product?.title || '',
        variant_title: item.variant_title || item.title || 'Default Title',
        quantity: item.quantity || 1,
        price: item.price || 0,
        price_cents: item.price_cents || Math.round(item.price * 100),
        compare_at_price: item.compare_at_price || 0,
        sku: item.sku || '',
        image: item.image || '',
        url: item.url || item.product?.url || '',
        vendor: item.vendor || item.product?.vendor || '',
        product_type: item.product_type || item.product?.type || '',
        price_formatted: item.price_formatted || ''
      };

      // Agregar opciones si existen
      if (item.option1) baseItem.option1 = item.option1;
      if (item.option2) baseItem.option2 = item.option2;
      if (item.option3) baseItem.option3 = item.option3;
      if (item.options) baseItem.options = item.options;

      return baseItem;
    }

    function construirDatosPedido(items, total = null) {
      const orderData = {
        orderNumber: 'LM' + Date.now(),
        items: Array.isArray(items) ? items.map(construirItemPedido) : [construirItemPedido(items)],
        timestamp: new Date().toISOString()
      };

      // Calcular totales si no se proporcionan
      if (total === null) {
        orderData.total = orderData.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        orderData.total_cents = orderData.items.reduce((sum, item) => sum + (item.price_cents * item.quantity), 0);
      } else {
        orderData.total = typeof total === 'number' ? total : (total / 100);
        orderData.total_cents = typeof total === 'number' ? (total * 100) : total;
      }

      orderData.subtotal = orderData.total;
      orderData.total_formatted = new Intl.NumberFormat('es-BO', {
        style: 'currency',
        currency: 'BOB'
      }).format(orderData.total);

      return orderData;
    }

    // ========== FUNCI√ìN DE CHECKOUT (CORE) ==========
    async function procesarCheckoutPersonalizado(orderData, options = {}) {
      const {
        limpiarCarrito = CONFIG.CART_CLEAR_ENABLED,
        cerrarDrawer = false,
        onSuccess = null,
        onError = null
      } = options;

      try {
        // Guardar datos del cliente
        guardarDatosCliente();

        // Guardar datos del pedido
        localStorage.setItem('customOrderData', JSON.stringify(orderData));
        debug.log('üíæ Datos guardados en localStorage:', orderData);

        // Limpiar carrito si es necesario
        if (limpiarCarrito) {
          await limpiarCarritoShopify();
        }

        // Cerrar drawer si es necesario
        if (cerrarDrawer) {
          cerrarMiniCartDrawer();
        }

        // Callback de √©xito
        if (onSuccess && typeof onSuccess === 'function') {
          onSuccess(orderData);
        }

        // Redirigir
        window.location.href = CONFIG.CHECKOUT_SUCCESS_URL;

      } catch (error) {
        debug.error('üí• Error en checkout personalizado:', error);
        
        if (onError && typeof onError === 'function') {
          onError(error);
        } else {
          // Fallback: redirigir de todas formas si ya se guardaron los datos
          if (localStorage.getItem('customOrderData')) {
            window.location.href = CONFIG.CHECKOUT_SUCCESS_URL;
          }
        }
      }
    }

    // ========== FUNCIONES AUXILIARES ==========
    async function limpiarCarritoShopify() {
      try {
        const response = await fetch('/cart/clear.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        debug.log('‚úÖ Carrito limpiado');
        return true;
      } catch (error) {
        debug.error('‚ùå Error al limpiar carrito:', error);
        throw error;
      }
    }

    function cerrarMiniCartDrawer() {
      const drawerToggle = document.querySelector('drawer-toggle[for="HeaderMiniCart"]');
      if (drawerToggle) {
        drawerToggle.click();
        debug.log('‚úÖ Drawer cerrado');
      }
    }

    // ========== EXPORTAR FUNCIONES P√öBLICAS ==========
    window.CustomCheckout = {
      // Funci√≥n principal
      procesar: procesarCheckoutPersonalizado,
      
      // Funciones auxiliares
      obtenerDatosCliente,
      guardarDatosCliente,
      construirDatosPedido,
      construirItemPedido,
      limpiarCarrito: limpiarCarritoShopify,
      cerrarDrawer: cerrarMiniCartDrawer,
      
      // Configuraci√≥n
      config: CONFIG,
      debug
    };

    debug.log('‚úÖ M√≥dulo CustomCheckout cargado');
  })();
</script>

{% schema %}
{
  "name": "Checkout Success",
  "settings": [
    {
      "type": "text",
      "id": "titulo_1",
      "label": "Titulo Principal",
      "default": "PEDIDO CONFIRMADO!",
      "info": "El titulo principal que se muestra en la pagina"
    },
    {
      "type": "text",
      "id": "titulo_2",
      "label": "Mensaje de Confirmacion",
      "default": "Gracias por escogernos. En breve nuestro equipo se contactara contigo via WhatsApp para coordinar la entrega de tu pedido.",
      "info": "El mensaje que aparece debajo del titulo"
    },
    {
      "type": "text",
      "id": "mensaje_whatsapp",
      "label": "Mensaje para WhatsApp",
      "default": "Buenas, mi numero de orden es el siguiente: {NUMERO_ORDEN}, por favor me atiende",
      "info": "Mensaje que se enviara por WhatsApp. Usa {NUMERO_ORDEN} donde quieras que aparezca el numero de orden"
    },
    {
      "type": "text",
      "id": "whatsapp_number",
      "label": "Numero de WhatsApp",
      "default": "+59178008717",
      "info": "Numero de WhatsApp para contacto (incluir codigo de pais sin +)"
    },
    {
      "type": "checkbox",
      "id": "show_phone_config",
      "label": "Mostrar configuracion de telefono",
      "default": false,
      "info": "Permite modificar el numero de WhatsApp desde la pagina"
    }
  ]
}
{% endschema %}
