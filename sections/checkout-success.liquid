{{ 'section-checkout-success.css' | asset_url | stylesheet_tag }}

<div class="checkout-success-container">
  <div class="checkout-success-content">
    <!-- Imagen de check verde -->
    <div class="success-icon">
      <img
        src="{{ 'imagen-check-verde.png' | asset_url }}"
        alt="Pedido Confirmado"
        class="success-image"
        width="80"
        height="80"
      >
    </div>

    <h1 class="success-title">{{ section.settings.titulo_1 | default: '¡PEDIDO CONFIRMADO!' }}</h1>

    <p class="success-message">
      {{
        section.settings.titulo_2
        | default: 'Gracias por escogernos. En breve nuestro equipo se contactará contigo vía WhatsApp para coordinar la entrega de tu pedido.'
      }}
    </p>

    <div class="order-number">
      <span>Número de Orden: <span id="numero-orden">Procesando...</span></span>
    </div>

    <!-- Estado del pedido -->
    <div id="estado-pedido" class="estado-procesando">
      <div class="loading-text">
        <p>Procesando orden...</p>
      </div>
    </div>

    <!-- Sección WhatsApp -->
    <div class="whatsapp-redirect" id="seccion-whatsapp" style="display: none;">
      <div class="countdown-container">
        <p class="redirect-message">Te redirigiremos a WhatsApp en <span id="countdown">5</span> segundos...</p>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
      </div>

      <button id="whatsapp-ahora" class="button button-whatsapp">Ir a WhatsApp</button>
    </div>

    <!-- Configuración del teléfono (solo si está habilitada) -->
    {% if section.settings.show_phone_config %}
      <div
        class="phone-config"
        style="margin-top: 2rem; padding: 1rem; background: rgba(var(--color-aux-background)); border-radius: var(--border-radius);"
      >
        <label for="phone-input" style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem;"
          >Número de WhatsApp:</label
        >
        <input
          type="text"
          id="phone-input"
          value="{{ section.settings.whatsapp_number }}"
          style="width: 100%; padding: 0.5rem; border: 1px solid rgba(var(--color-border)); border-radius: var(--border-radius);"
        >
        <small style="display: block; margin-top: 0.5rem; opacity: 0.7;">Incluir código de país sin +</small>
      </div>
    {% endif %}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const NETLIFY_FUNCTION_URL = 'https://api-aux-ferroman.netlify.app/.netlify/functions/crear-orden';

    // Obtener datos
    const datosDelPedido = JSON.parse(localStorage.getItem('customOrderData') || '{}');
    const datosDelCliente = JSON.parse(localStorage.getItem('customerData') || '{}');
    let numeroWhatsApp = '{{ section.settings.whatsapp_number }}';

    // Mensaje personalizable de WhatsApp
    const mensajeWhatsAppTemplate = `{{ section.settings.mensaje_whatsapp | default: 'Buenas, mi número de orden es el siguiente: {NUMERO_ORDEN}, por favor me atiende' }}`;

    // Actualizar número si hay input de configuración
    const phoneInput = document.getElementById('phone-input');
    if (phoneInput) {
      phoneInput.addEventListener('input', function () {
        numeroWhatsApp = this.value;
      });
    }

    // Crear orden
    crearOrden(datosDelPedido, datosDelCliente);

    async function crearOrden(datosPedido, datosCliente) {
      let numeroOrden = '';

      try {
        actualizarEstado('Procesando orden...');

        // Preparar datos
        const bodyData = {
          productos: datosPedido.items || [],
          total: datosPedido.total,
          tienda: '{{ shop.permanent_domain }}',
          timestamp: new Date().toISOString(),
        };

        // Agregar cliente si está logueado
        if (datosCliente.logueado) {
          bodyData.cliente = {
            nombre: datosCliente.nombre || 'Cliente',
            email: datosCliente.email || '',
            telefono: datosCliente.telefono || '',
            direccion: datosCliente.direccion || '',
          };
        }

        const respuesta = await fetch(NETLIFY_FUNCTION_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(bodyData),
        });

        const resultado = await respuesta.json();

        if (resultado.success) {
          numeroOrden = resultado.numeroOrden || resultado.orderNumber || `LM-${Date.now().toString().slice(-8)}`;
          document.getElementById('numero-orden').textContent = numeroOrden;
          actualizarEstado('Orden procesada exitosamente');
        } else {
          throw new Error(resultado.error || 'Error desconocido');
        }
      } catch (error) {
        console.error('Error:', error);
        numeroOrden = `LM-${Date.now().toString().slice(-8)}`;
        document.getElementById('numero-orden').textContent = numeroOrden;
        actualizarEstado('Orden registrada');
      }

      // Esperar 2 segundos y mostrar WhatsApp
      setTimeout(() => {
        document.getElementById('seccion-whatsapp').style.display = 'block';
        iniciarContadorWhatsApp(numeroOrden);
      }, 2000);
    }

    function actualizarEstado(mensaje) {
      document.getElementById('estado-pedido').innerHTML = `
        <div class="loading-text">
          <p>${mensaje}</p>
        </div>
      `;
    }

    function iniciarContadorWhatsApp(numeroOrden) {
      // Reemplazar {NUMERO_ORDEN} en el mensaje personalizable
      const mensajeWhatsApp = mensajeWhatsAppTemplate.replace('{NUMERO_ORDEN}', numeroOrden);
      const urlWhatsApp = `https://wa.me/${numeroWhatsApp}?text=${encodeURIComponent(mensajeWhatsApp)}`;

      let contador = 5;
      const elementoContador = document.getElementById('countdown');
      const barraProgreso = document.getElementById('progress-fill');

      const temporizador = setInterval(() => {
        contador--;
        elementoContador.textContent = contador;

        const progreso = ((5 - contador) / 5) * 100;
        barraProgreso.style.width = progreso + '%';

        if (contador <= 0) {
          clearInterval(temporizador);
          window.open(urlWhatsApp, '_blank');
        }
      }, 1000);

      // Botón simple
      document.getElementById('whatsapp-ahora').addEventListener('click', function () {
        clearInterval(temporizador);
        window.open(urlWhatsApp, '_blank');
      });
    }

    // Limpiar datos
    setTimeout(() => {
      localStorage.removeItem('customOrderData');
      localStorage.removeItem('customerData');
    }, 15000);
  });
</script>

{% schema %}
{
  "name": "Checkout Success",
  "settings": [
    {
      "type": "text",
      "id": "titulo_1",
      "label": "Título Principal",
      "default": "¡PEDIDO CONFIRMADO!",
      "info": "El título principal que se muestra en la página"
    },
    {
      "type": "textarea",
      "id": "titulo_2",
      "label": "Mensaje de Confirmación",
      "default": "Gracias por escogernos. En breve nuestro equipo se contactará contigo vía WhatsApp para coordinar la entrega de tu pedido.",
      "info": "El mensaje que aparece debajo del título"
    },
    {
      "type": "textarea",
      "id": "mensaje_whatsapp",
      "label": "Mensaje para WhatsApp",
      "default": "Buenas, mi número de orden es el siguiente: {NUMERO_ORDEN}, por favor me atiende",
      "info": "Mensaje que se enviará por WhatsApp. Usa {NUMERO_ORDEN} donde quieras que aparezca el número de orden"
    },
    {
      "type": "text",
      "id": "whatsapp_number",
      "label": "Número de WhatsApp",
      "default": "59178123456",
      "info": "Número de WhatsApp para contacto (incluir código de país sin +)"
    },
    {
      "type": "checkbox",
      "id": "show_phone_config",
      "label": "Mostrar configuración de teléfono",
      "default": false,
      "info": "Permite modificar el número de WhatsApp desde la página"
    }
  ]
}
{% endschema %}
