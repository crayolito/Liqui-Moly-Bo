{{ 'section-checkout-success.css' | asset_url | stylesheet_tag }}

<div class="checkout-success-container">
  <div class="checkout-success-content">
    <!-- Imagen de check verde -->
    <div class="success-icon">
      <img
        src="{{ 'imagen-check-verde.png' | asset_url }}"
        alt="Pedido Confirmado"
        class="success-image"
        width="80"
        height="80"
      >
    </div>

    <h1 class="success-title">{{ section.settings.titulo_1 | default: '¬°PEDIDO CONFIRMADO!' }}</h1>

    <p class="success-message">
      {{
        section.settings.titulo_2
        | default: 'Gracias por escogernos. En breve nuestro equipo se contactar√° contigo v√≠a WhatsApp para coordinar la entrega de tu pedido.'
      }}
    </p>
    <div class="order-number">
      <span>N√∫mero de Orden: <span id="numero-orden">Procesando...</span></span>
    </div>

    <!-- Estado del pedido -->
    <div id="estado-pedido" class="estado-procesando">
      <div class="loading-text">
        <p>Procesando orden...</p>
      </div>
    </div>

    <!-- Secci√≥n WhatsApp -->
    <div class="whatsapp-redirect" id="seccion-whatsapp" style="display: none;">
      <div class="countdown-container">
        <p class="redirect-message">Te redirigiremos a WhatsApp en <span id="countdown">5</span> segundos...</p>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
      </div>

      <button id="whatsapp-ahora" class="button button-whatsapp">Ir a WhatsApp</button>
    </div>

    <!-- Configuraci√≥n del tel√©fono (solo si est√° habilitada) -->
    {% if section.settings.show_phone_config %}
      <div
        class="phone-config"
        style="margin-top: 2rem; padding: 1rem; background: rgba(var(--color-aux-background)); border-radius: var(--border-radius);"
      >
        <label for="phone-input" style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem;"
          >N√∫mero de WhatsApp:</label
        >
        <input
          type="text"
          id="phone-input"
          value="{{ section.settings.whatsapp_number }}"
          style="width: 100%; padding: 0.5rem; border: 1px solid rgba(var(--color-border)); border-radius: var(--border-radius);"
        >
        <small style="display: block; margin-top: 0.5rem; opacity: 0.7;">Incluir c√≥digo de pa√≠s sin +</small>
      </div>
    {% endif %}
  </div>
</div>

{% assign mensaje_default = 'Buenas, mi n√∫mero de orden es el siguiente: {NUMERO_ORDEN}, por favor me atiende' %}

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const NETLIFY_FUNCTION_URL = 'https://api-aux-ferroman.netlify.app/.netlify/functions/crear-orden';

    // Obtener datos
    let numeroWhatsApp = '{{ section.settings.whatsapp_number }}';
    const mensajeWhatsAppTemplate = `{{ section.settings.mensaje_whatsapp | default: mensaje_default | escape }}`;

    // Actualizar n√∫mero si hay input de configuraci√≥n
    const phoneInput = document.getElementById('phone-input');
    if (phoneInput) {
      phoneInput.addEventListener('input', function () {
        numeroWhatsApp = this.value;
      });
    }

    // Verificar que el m√≥dulo CustomCheckout est√© disponible
    if (!window.CustomCheckout) {
      console.error('‚ùå M√≥dulo CustomCheckout no disponible');
      actualizarEstado('Error: Sistema de checkout no disponible');
      return;
    }

    // Obtener y validar datos
    const datosDelPedido = JSON.parse(localStorage.getItem('customOrderData') || '{}');
    const datosDelCliente = JSON.parse(localStorage.getItem('customerData') || '{}');

    if (!datosDelPedido || !datosDelPedido.items || datosDelPedido.items.length === 0) {
      console.error('‚ùå NO HAY DATOS DEL PEDIDO');
      actualizarEstado('Error: No se encontraron datos del pedido');
      return;
    }

    // Procesar la orden
    crearOrden(datosDelPedido, datosDelCliente);

    async function crearOrden(datosPedido, datosCliente) {
      let numeroOrden = '';

      try {
        actualizarEstado('Procesando orden...');

        // 1. CREAR DRAFT ORDER con GraphQL
        const createDraftOrderMutation = `
        mutation draftOrderCreate($input: DraftOrderInput!) {
          draftOrderCreate(input: $input) {
            draftOrder {
              id
              name
              totalPrice
            }
            userErrors {
              field
              message
            }
          }
        }`;

        const createVariables = {
          input: {
            lineItems: datosPedido.items.map((item) => ({
              variantId: `gid://shopify/ProductVariant/${item.variant_id}`,
              quantity: item.quantity,
            })),
            email: datosCliente.logueado ? datosCliente.email : '',
            note: `Orden desde web - ${new Date().toISOString()}`,
          },
        };

        const createResponse = await fetch(NETLIFY_FUNCTION_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            query: createDraftOrderMutation,
            variables: createVariables,
          }),
        });

        const createResult = await createResponse.json();

        if (!createResult.success || createResult.errors) {
          throw new Error('Error creando draft order: ' + JSON.stringify(createResult.errors));
        }

        const draftOrderId = createResult.data.draftOrderCreate.draftOrder.id;
        const draftOrderName = createResult.data.draftOrderCreate.draftOrder.name;

        // 2. COMPLETAR DRAFT ORDER
        actualizarEstado('Finalizando orden...');

        const completeDraftOrderMutation = `
        mutation draftOrderComplete($id: ID!, $paymentPending: Boolean) {
          draftOrderComplete(id: $id, paymentPending: $paymentPending) {
            draftOrder {
              order {
                id
                name
                totalPrice
                displayFinancialStatus
              }
            }
            userErrors {
              field
              message
            }
          }
        }`;

        const completeResponse = await fetch(NETLIFY_FUNCTION_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            query: completeDraftOrderMutation,
            variables: {
              id: draftOrderId,
              paymentPending: true,
            },
          }),
        });

        const completeResult = await completeResponse.json();

        if (
          completeResult.success &&
          !completeResult.errors &&
          completeResult.data.draftOrderComplete.draftOrder.order
        ) {
          const order = completeResult.data.draftOrderComplete.draftOrder.order;
          numeroOrden = order.name;
          actualizarEstado('Orden procesada exitosamente');
        } else {
          numeroOrden = draftOrderName;
          actualizarEstado('Orden registrada como borrador');
        }

        if (document.getElementById('numero-orden')) {
          document.getElementById('numero-orden').textContent = numeroOrden;
        }
      } catch (error) {
        console.error('üí• Error procesando orden:', error);
        numeroOrden = `LM-${Date.now().toString().slice(-8)}`;
        if (document.getElementById('numero-orden')) {
          document.getElementById('numero-orden').textContent = numeroOrden;
        }
        actualizarEstado('Error procesando orden - N√∫mero temporal asignado');
      }

      // Continuar con WhatsApp despu√©s de 2 segundos
      setTimeout(() => {
        const seccionWhatsApp = document.getElementById('seccion-whatsapp');
        if (seccionWhatsApp) {
          seccionWhatsApp.style.display = 'block';
        }
        iniciarContadorWhatsApp(numeroOrden);
      }, 2000);
    }

    function actualizarEstado(mensaje) {
      const estadoPedido = document.getElementById('estado-pedido');
      if (estadoPedido) {
        estadoPedido.innerHTML = `
          <div class="loading-text">
            <p>${mensaje}</p>
          </div>
        `;
      }
    }

    function iniciarContadorWhatsApp(numeroOrden) {
      const mensajeWhatsApp = mensajeWhatsAppTemplate.replace('{NUMERO_ORDEN}', numeroOrden);
      const urlWhatsApp = `https://wa.me/${numeroWhatsApp}?text=${encodeURIComponent(mensajeWhatsApp)}`;

      let contador = 5;
      const elementoContador = document.getElementById('countdown');
      const barraProgreso = document.getElementById('progress-fill');

      if (!elementoContador || !barraProgreso) return;

      const temporizador = setInterval(() => {
        contador--;
        elementoContador.textContent = contador;
        const progreso = ((5 - contador) / 5) * 100;
        barraProgreso.style.width = progreso + '%';

        if (contador <= 0) {
          clearInterval(temporizador);
          window.open(urlWhatsApp, '_blank');
        }
      }, 1000);

      const btnWhatsApp = document.getElementById('whatsapp-ahora');
      if (btnWhatsApp) {
        btnWhatsApp.addEventListener('click', function () {
          clearInterval(temporizador);
          window.open(urlWhatsApp, '_blank');
        });
      }
    }

    // Limpiar storage despu√©s de 15 segundos
    setTimeout(() => {
      localStorage.removeItem('customOrderData');
      localStorage.removeItem('customerData');
    }, 15000);
  });
</script>

{% schema %}
{
  "name": "Checkout Success",
  "settings": [
    {
      "type": "text",
      "id": "titulo_1",
      "label": "Titulo Principal",
      "default": "PEDIDO CONFIRMADO!",
      "info": "El titulo principal que se muestra en la pagina"
    },
    {
      "type": "text",
      "id": "titulo_2",
      "label": "Mensaje de Confirmacion",
      "default": "Gracias por escogernos. En breve nuestro equipo se contactara contigo via WhatsApp para coordinar la entrega de tu pedido.",
      "info": "El mensaje que aparece debajo del titulo"
    },
    {
      "type": "text",
      "id": "mensaje_whatsapp",
      "label": "Mensaje para WhatsApp",
      "default": "Buenas, mi numero de orden es el siguiente: {NUMERO_ORDEN}, por favor me atiende",
      "info": "Mensaje que se enviara por WhatsApp. Usa {NUMERO_ORDEN} donde quieras que aparezca el numero de orden"
    },
    {
      "type": "text",
      "id": "whatsapp_number",
      "label": "Numero de WhatsApp",
      "default": "+59178008717",
      "info": "Numero de WhatsApp para contacto (incluir codigo de pais sin +)"
    },
    {
      "type": "checkbox",
      "id": "show_phone_config",
      "label": "Mostrar configuracion de telefono",
      "default": false,
      "info": "Permite modificar el numero de WhatsApp desde la pagina"
    }
  ]
}
{% endschema %}
