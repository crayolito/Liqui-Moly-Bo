{{ 'section-checkout-success.css' | asset_url | stylesheet_tag }}

<div class="checkout-success-container">
  <div class="checkout-success-content">
    <div class="success-icon">
      <img
        src="{{ 'imagen-check-verde.png' | asset_url }}"
        alt="Pedido Confirmado"
        class="success-image"
        width="100"
        height="100"
      >
    </div>

    <h1 class="success-title">¬°PEDIDO CONFIRMADO!</h1>

    <p class="success-message">
      En breve te conectaremos con nuestro equipo<br>
      v√≠a WhatsApp para coordinar tu entrega
    </p>

    <div class="order-number">
      <span>Orden #<span id="numero-orden">Procesando...</span></span>
    </div>

    <div class="order-details" id="detalles-pedido">
      <!-- Los detalles del pedido se cargar√°n aqu√≠ -->
    </div>

    <!-- Estado del pedido -->
    <div id="estado-pedido" class="estado-procesando">
      <p>üìù Creando orden en Shopify...</p>
    </div>

    <!-- Contador y redirecci√≥n autom√°tica -->
    <div class="whatsapp-redirect" id="seccion-whatsapp" style="display: none;">
      <div class="countdown-container">
        <div class="whatsapp-icon">üì±</div>
        <p class="redirect-message">Te redirigiremos a WhatsApp en <span id="countdown">3</span> segundos...</p>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
      </div>

      <button id="whatsapp-ahora" class="button button-whatsapp">Ir a WhatsApp Ahora</button>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Configuraci√≥n con Admin API (usando tus credenciales actuales)
    const configuracionAPI = {
      adminSecret: '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', // Tu secret actual
      clientId: '6727999b827a6321a8bf0c5814c841c8', // Tu client ID
      tiendaUrl: '{{ shop.permanent_domain }}',
      apiVersion: '2024-10', // Versi√≥n estable
    };

    // Variables en espa√±ol
    const datosDelPedido = JSON.parse(localStorage.getItem('customOrderData') || '{}');
    const numeroWhatsApp = '{{ section.settings.whatsapp_number }}';

    // Mostrar detalles del pedido inmediatamente
    if (datosDelPedido.items) {
      mostrarDetallesPedido(datosDelPedido.items, datosDelPedido.total);
    }

    // Crear orden real en Shopify usando Admin API
    crearOrdenConAdminAPI(datosDelPedido, configuracionAPI);

    // Funci√≥n principal para crear Draft Order con Admin API
    async function crearOrdenConAdminAPI(datosPedido, config) {
      try {
        actualizarEstadoPedido('üîÑ Conectando con Shopify...');

        // Preparar datos de la orden borrador
        const ordenBorrador = {
          draft_order: {
            line_items: datosPedido.items.map((producto) => ({
              title: producto.title,
              quantity: producto.quantity,
              price: extraerPrecioNumerico(producto.price),
              custom: true, // Producto personalizado
              variant_title: producto.variant || 'Default',
            })),
            customer: {
              first_name: 'Cliente',
              last_name: 'WhatsApp',
              email: `cliente.${Date.now()}@checkout-personalizado.com`,
            },
            note: `Pedido desde checkout personalizado - ${new Date().toLocaleString('es-ES')}`,
            tags: ['checkout-personalizado', 'whatsapp'],
            use_customer_default_address: false,
            financial_status: 'pending',
          },
        };

        actualizarEstadoPedido('üìù Creando orden en Shopify...');

        // Crear Draft Order usando Admin API
        const respuesta = await fetch(`https://${config.tiendaUrl}/admin/api/${config.apiVersion}/draft_orders.json`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Shopify-Access-Token': config.adminSecret,
          },
          body: JSON.stringify(ordenBorrador),
        });

        if (respuesta.ok) {
          const resultado = await respuesta.json();
          const numeroOrden = resultado.draft_order.name || `#${resultado.draft_order.id}`;

          // Actualizar n√∫mero de orden en la p√°gina
          document.getElementById('numero-orden').textContent = numeroOrden;

          // Actualizar estado exitoso
          actualizarEstadoPedido('‚úÖ ¬°Orden creada exitosamente en Shopify!');

          // Mostrar secci√≥n de WhatsApp despu√©s de 2 segundos
          setTimeout(() => {
            document.getElementById('seccion-whatsapp').style.display = 'block';
            iniciarContadorWhatsApp(numeroOrden);
          }, 2000);
        } else {
          const errorData = await respuesta.json();
          throw new Error(`Error HTTP ${respuesta.status}: ${JSON.stringify(errorData)}`);
        }
      } catch (error) {
        console.error('Error creando orden:', error);

        // Usar n√∫mero temporal si falla la API
        const numeroTemporal = 'LM-' + Date.now().toString().slice(-8);
        document.getElementById('numero-orden').textContent = numeroTemporal;

        actualizarEstadoPedido('‚ö†Ô∏è Orden registrada localmente - Contacta por WhatsApp');

        // Mostrar WhatsApp inmediatamente si falla
        setTimeout(() => {
          document.getElementById('seccion-whatsapp').style.display = 'block';
          iniciarContadorWhatsApp(numeroTemporal);
        }, 1000);
      }
    }

    // Funci√≥n para extraer precio num√©rico
    function extraerPrecioNumerico(precioTexto) {
      if (!precioTexto || precioTexto === 'Precio no disponible') {
        return '0.00';
      }

      // Limpiar el precio: quitar s√≠mbolos y dejar solo n√∫meros y punto
      const numeroLimpio = precioTexto.toString().replace(/[^\d.,]/g, '');

      // Convertir comas a puntos si es necesario
      const numeroConPunto = numeroLimpio.replace(',', '.');

      // Extraer solo la parte num√©rica
      const precio = parseFloat(numeroConPunto) || 0;

      return precio.toFixed(2);
    }

    // Funci√≥n para actualizar el estado del pedido
    function actualizarEstadoPedido(mensaje) {
      const elementoEstado = document.getElementById('estado-pedido');
      elementoEstado.innerHTML = `<p>${mensaje}</p>`;
    }

    // Funci√≥n para iniciar contador de WhatsApp
    function iniciarContadorWhatsApp(numeroOrden) {
      const mensajeWhatsApp = `Buenas, quisiera atenci√≥n por favor. Mi n√∫mero de orden es el siguiente: #${numeroOrden}`;
      const urlWhatsApp = `https://wa.me/${numeroWhatsApp}?text=${encodeURIComponent(mensajeWhatsApp)}`;

      // Contador regresivo
      let contador = 3;
      const elementoContador = document.getElementById('countdown');
      const barraProgreso = document.getElementById('progress-fill');

      const temporizador = setInterval(() => {
        contador--;
        elementoContador.textContent = contador;

        // Actualizar barra de progreso
        const progreso = ((3 - contador) / 3) * 100;
        barraProgreso.style.width = progreso + '%';

        if (contador <= 0) {
          clearInterval(temporizador);
          window.open(urlWhatsApp, '_blank');
        }
      }, 1000);

      // Bot√≥n manual de WhatsApp
      document.getElementById('whatsapp-ahora').addEventListener('click', function () {
        clearInterval(temporizador);
        window.open(urlWhatsApp, '_blank');
      });
    }

    // Funci√≥n para mostrar detalles del pedido
    function mostrarDetallesPedido(productos, total) {
      const contenedorDetalles = document.getElementById('detalles-pedido');
      let html = '<div class="order-summary"><h3>Resumen del Pedido:</h3><ul>';

      productos.forEach((producto) => {
        html += `<li>
            <span class="item-qty">${producto.quantity}x</span> 
            <span class="item-name">${producto.title}</span>`;

        if (producto.variant && producto.variant !== 'Default Title' && producto.variant !== 'Seleccionado') {
          html += ` <span class="item-variant">(${producto.variant})</span>`;
        }

        html += ` <span class="item-price">${producto.price}</span>
          </li>`;
      });

      html += `</ul><div class="order-total"><strong>Total: ${total}</strong></div></div>`;
      contenedorDetalles.innerHTML = html;
    }

    // Limpiar datos despu√©s de procesar
    setTimeout(() => {
      localStorage.removeItem('customOrderData');
    }, 10000); // 10 segundos
  });
</script>

{% schema %}
{
  "name": "Checkout Success",
  "settings": [
    {
      "type": "text",
      "id": "whatsapp_number",
      "label": "N√∫mero de WhatsApp",
      "default": "59178123456",
      "info": "N√∫mero de WhatsApp para contacto (incluir c√≥digo de pa√≠s sin +)"
    },
    {
      "type": "text",
      "id": "storefront_token",
      "label": "Storefront Access Token",
      "info": "Token de acceso de Storefront API para crear √≥rdenes reales"
    }
  ]
}
{% endschema %}
