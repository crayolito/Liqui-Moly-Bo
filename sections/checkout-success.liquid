{{ 'section-checkout-success.css' | asset_url | stylesheet_tag }}

<div class="checkout-success-container">
  <div class="checkout-success-content">
    <div class="success-icon">
      <img
        src="{{ 'imagen-check-verde.png' | asset_url }}"
        alt="Pedido Confirmado"
        class="success-image"
        width="100"
        height="100"
      >
    </div>

    <h1 class="success-title">¬°PEDIDO CONFIRMADO!</h1>

    <p class="success-message">
      En breve te conectaremos con nuestro equipo<br>
      v√≠a WhatsApp para coordinar tu entrega
    </p>

    <div class="order-number">
      <span>Orden #<span id="numero-orden">Procesando...</span></span>
    </div>

    <div class="order-details" id="detalles-pedido">
      <!-- Los detalles del pedido se cargar√°n aqu√≠ -->
    </div>

    <!-- Estado del pedido -->
    <div id="estado-pedido" class="estado-procesando">
      <p>üìù Creando orden en Shopify...</p>
    </div>

    <!-- Contador y redirecci√≥n autom√°tica -->
    <div class="whatsapp-redirect" id="seccion-whatsapp" style="display: none;">
      <div class="countdown-container">
        <div class="whatsapp-icon">üì±</div>
        <p class="redirect-message">Te redirigiremos a WhatsApp en <span id="countdown">3</span> segundos...</p>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
      </div>

      <button id="whatsapp-ahora" class="button button-whatsapp">Ir a WhatsApp Ahora</button>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // URL de tu funci√≥n Netlify
    const NETLIFY_FUNCTION_URL = 'https://api-aux-ferroman.netlify.app/.netlify/functions/crear-orden';

    // Variables
    const datosDelPedido = JSON.parse(localStorage.getItem('customOrderData') || '{}');
    const numeroWhatsApp = '{{ section.settings.whatsapp_number }}';

    // Mostrar detalles inmediatamente
    if (datosDelPedido.items) {
      mostrarDetallesPedido(datosDelPedido.items, datosDelPedido.total);
    }

    // Crear orden real usando Netlify
    crearOrdenConNetlify(datosDelPedido);

    async function crearOrdenConNetlify(datosPedido) {
      try {
        actualizarEstadoPedido('üîÑ Conectando con Shopify...');

        // Preparar datos del cliente (si est√°n disponibles)
        const cliente = datosPedido.customer || datosPedido.cliente || null;
        const direccionEnvio = datosPedido.shipping_address || datosPedido.direccionEnvio || null;
        const direccionFacturacion = datosPedido.billing_address || datosPedido.direccionFacturacion || null;
        const transaccion = datosPedido.transaction || datosPedido.transaccion || null;

        // Preparar body con toda la informaci√≥n disponible
        const bodyData = {
          productos: datosPedido.items || [],
          total: datosPedido.total,
          tienda: '{{ shop.permanent_domain }}',
        };

        // Agregar informaci√≥n adicional si est√° disponible
        if (cliente) {
          bodyData.cliente = cliente;
        }
        if (direccionEnvio) {
          bodyData.direccionEnvio = direccionEnvio;
        }
        if (direccionFacturacion) {
          bodyData.direccionFacturacion = direccionFacturacion;
        }
        if (transaccion) {
          bodyData.transaccion = transaccion;
        }

        const respuesta = await fetch(NETLIFY_FUNCTION_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(bodyData),
        });

        const resultado = await respuesta.json();

        if (resultado.success) {
          // Orden creada exitosamente
          const numeroOrden = resultado.numeroOrden || resultado.orderNumber || `#${resultado.orderId}`;
          document.getElementById('numero-orden').textContent = numeroOrden;
          actualizarEstadoPedido('‚úÖ ¬°Orden creada exitosamente en Shopify!');

          setTimeout(() => {
            document.getElementById('seccion-whatsapp').style.display = 'block';
            iniciarContadorWhatsApp(numeroOrden);
          }, 2000);
        } else {
          throw new Error(resultado.error || 'Error desconocido');
        }
      } catch (error) {
        console.error('Error:', error);

        // Fallback
        const numeroTemporal = 'LM-' + Date.now().toString().slice(-8);
        document.getElementById('numero-orden').textContent = numeroTemporal;
        actualizarEstadoPedido('‚ö†Ô∏è Orden registrada localmente - Contacta por WhatsApp');

        setTimeout(() => {
          document.getElementById('seccion-whatsapp').style.display = 'block';
          iniciarContadorWhatsApp(numeroTemporal);
        }, 1000);
      }
    }

    function actualizarEstadoPedido(mensaje) {
      document.getElementById('estado-pedido').innerHTML = `<p>${mensaje}</p>`;
    }

    function iniciarContadorWhatsApp(numeroOrden) {
      const mensajeWhatsApp = `Buenas, quisiera atenci√≥n por favor. Mi n√∫mero de orden es el siguiente: #${numeroOrden}`;
      const urlWhatsApp = `https://wa.me/${numeroWhatsApp}?text=${encodeURIComponent(mensajeWhatsApp)}`;

      let contador = 3;
      const elementoContador = document.getElementById('countdown');
      const barraProgreso = document.getElementById('progress-fill');

      const temporizador = setInterval(() => {
        contador--;
        elementoContador.textContent = contador;

        const progreso = ((3 - contador) / 3) * 100;
        barraProgreso.style.width = progreso + '%';

        if (contador <= 0) {
          clearInterval(temporizador);
          window.open(urlWhatsApp, '_blank');
        }
      }, 1000);

      document.getElementById('whatsapp-ahora').addEventListener('click', function () {
        clearInterval(temporizador);
        window.open(urlWhatsApp, '_blank');
      });
    }

    function mostrarDetallesPedido(productos, total) {
      const contenedorDetalles = document.getElementById('detalles-pedido');
      let html = '<div class="order-summary"><h3>Resumen del Pedido:</h3><ul>';

      productos.forEach((producto) => {
        html += `<li>
              <span class="item-qty">${producto.quantity}x</span> 
              <span class="item-name">${producto.title}</span>`;

        if (producto.variant && producto.variant !== 'Default Title' && producto.variant !== 'Seleccionado') {
          html += ` <span class="item-variant">(${producto.variant})</span>`;
        }

        html += ` <span class="item-price">${producto.price}</span></li>`;
      });

      html += `</ul><div class="order-total"><strong>Total: ${total}</strong></div></div>`;
      contenedorDetalles.innerHTML = html;
    }

    setTimeout(() => {
      localStorage.removeItem('customOrderData');
    }, 10000);
  });
</script>
{% schema %}
{
  "name": "Checkout Success",
  "settings": [
    {
      "type": "text",
      "id": "whatsapp_number",
      "label": "N√∫mero de WhatsApp",
      "default": "59178123456",
      "info": "N√∫mero de WhatsApp para contacto (incluir c√≥digo de pa√≠s sin +)"
    },
    {
      "type": "text",
      "id": "storefront_token",
      "label": "Storefront Access Token",
      "info": "Token de acceso de Storefront API para crear √≥rdenes reales"
    }
  ]
}
{% endschema %}
